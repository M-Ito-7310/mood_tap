# Phase 10: データエクスポート

**作成日**: 2025年10月23日
**Phase**: 10/12
**所要時間**: 30-45分
**前提条件**: Phase 1-9完了

---

## Phase概要

### 目的
気分記録データをCSV形式でエクスポートし、カウンセラーとの共有や外部分析を可能にする。

### 成果物
- `lib/export.ts`: CSV生成関数
- `components/settings/ExportButton.tsx`: エクスポートボタン
- `app/settings/page.tsx`: 設定ページ

---

## 実装タスク詳細

### タスク1: CSV生成関数 (15分)

#### ファイル: `lib/export.ts`

```typescript
import { MoodEntry, MOOD_LABEL_DISPLAY_NAME } from '@/types/mood';

/**
 * MoodEntryをCSV形式に変換
 */
export function convertToCSV(entries: MoodEntry[]): string {
  // ヘッダー
  const header = ['日付', '気分スコア', '気分', 'メモ', '作成日時'];

  // データ行
  const rows = entries.map((entry) => [
    entry.date,
    entry.moodScore.toString(),
    MOOD_LABEL_DISPLAY_NAME[entry.moodLabel],
    entry.note || '',
    entry.createdAt,
  ]);

  // CSV組み立て
  const csvContent = [
    header.join(','),
    ...rows.map((row) =>
      row.map((cell) => `"${cell.replace(/"/g, '""')}"`).join(',')
    ),
  ].join('\n');

  return csvContent;
}

/**
 * CSVファイルをダウンロード
 */
export function downloadCSV(entries: MoodEntry[], filename: string = 'moodtap-export.csv') {
  const csv = convertToCSV(entries);
  const bom = '\uFEFF'; // UTF-8 BOM (Excel対応)
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });

  // ダウンロードリンク作成
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  URL.revokeObjectURL(url);
}

/**
 * JSON形式でエクスポート
 */
export function downloadJSON(entries: MoodEntry[], filename: string = 'moodtap-export.json') {
  const json = JSON.stringify(entries, null, 2);
  const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });

  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  URL.revokeObjectURL(url);
}
```

### タスク2: ExportButtonコンポーネント (15分)

#### ファイル: `components/settings/ExportButton.tsx`

```typescript
'use client';

import { useState } from 'react';
import { MoodEntry } from '@/types/mood';
import { downloadCSV, downloadJSON } from '@/lib/export';
import { formatDateISO } from '@/lib/utils';

interface ExportButtonProps {
  entries: MoodEntry[];
}

export function ExportButton({ entries }: ExportButtonProps) {
  const [isExporting, setIsExporting] = useState(false);

  const handleExportCSV = () => {
    setIsExporting(true);

    const filename = `moodtap-export-${formatDateISO(new Date())}.csv`;
    downloadCSV(entries, filename);

    setTimeout(() => setIsExporting(false), 1000);
  };

  const handleExportJSON = () => {
    setIsExporting(true);

    const filename = `moodtap-export-${formatDateISO(new Date())}.json`;
    downloadJSON(entries, filename);

    setTimeout(() => setIsExporting(false), 1000);
  };

  return (
    <div className="space-y-3">
      <button
        onClick={handleExportCSV}
        disabled={isExporting || entries.length === 0}
        className="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isExporting ? 'エクスポート中...' : 'CSV形式でエクスポート'}
      </button>

      <button
        onClick={handleExportJSON}
        disabled={isExporting || entries.length === 0}
        className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isExporting ? 'エクスポート中...' : 'JSON形式でエクスポート'}
      </button>

      {entries.length === 0 && (
        <p className="text-sm text-gray-500 text-center">
          エクスポートできるデータがありません
        </p>
      )}
    </div>
  );
}
```

### タスク3: 設定ページ (20分)

#### ファイル: `app/settings/page.tsx`

```typescript
import { SettingsClient } from './SettingsClient';

export default function SettingsPage() {
  return <SettingsClient />;
}
```

#### ファイル: `app/settings/SettingsClient.tsx`

```typescript
'use client';

import { useMoodEntries } from '@/hooks/useMoodEntries';
import { ExportButton } from '@/components/settings/ExportButton';
import { clearAllMoodEntries } from '@/lib/localStorage';
import { useState } from 'react';

export function SettingsClient() {
  const { entries, isLoading } = useMoodEntries();
  const [showClearConfirm, setShowClearConfirm] = useState(false);

  const handleClearData = () => {
    if (confirm('全ての記録を削除します。この操作は取り消せません。本当によろしいですか?')) {
      clearAllMoodEntries();
      window.location.reload();
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-xl text-gray-600">読み込み中...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background-light py-8 px-4">
      <div className="max-w-2xl mx-auto">
        <header className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">設定</h1>
          <p className="text-gray-600 mt-2">データ管理</p>
        </header>

        <div className="space-y-6">
          {/* データエクスポート */}
          <section className="card">
            <h2 className="text-xl font-semibold mb-4">データエクスポート</h2>
            <p className="text-gray-600 mb-6">
              記録したデータをファイルとしてダウンロードできます。
              カウンセラーとの共有や外部分析に活用してください。
            </p>
            <ExportButton entries={entries} />
          </section>

          {/* データ統計 */}
          <section className="card">
            <h2 className="text-xl font-semibold mb-4">データ統計</h2>
            <div className="space-y-3 text-gray-700">
              <div className="flex justify-between">
                <span>総記録数</span>
                <span className="font-semibold">{entries.length} 件</span>
              </div>
              <div className="flex justify-between">
                <span>メモ付き記録</span>
                <span className="font-semibold">
                  {entries.filter((e) => e.note).length} 件
                </span>
              </div>
            </div>
          </section>

          {/* データ削除 */}
          <section className="card border-2 border-red-200">
            <h2 className="text-xl font-semibold mb-4 text-red-600">危険な操作</h2>
            <p className="text-gray-600 mb-6">
              全ての記録を削除します。この操作は取り消せません。
            </p>
            <button
              onClick={handleClearData}
              className="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors"
            >
              全データを削除
            </button>
          </section>
        </div>
      </div>
    </div>
  );
}
```

---

## チェックリスト

- [ ] CSV形式でエクスポートできる
- [ ] JSON形式でエクスポートできる
- [ ] ファイルが正しくダウンロードされる
- [ ] Excelで開ける (UTF-8 BOM付き)
- [ ] データ削除機能が動作する

---

## 次のPhaseへの接続

Phase 11でデータベース移行準備を実装します。

---

**ドキュメント作成者**: AI Agent (Claude)
**最終更新日**: 2025年10月23日
**バージョン**: 1.0
